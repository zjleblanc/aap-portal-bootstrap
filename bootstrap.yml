---
- name: AAP Portal Bootstrap
  hosts: localhost
  gather_facts: false
  become: false

  vars:
    # --- Important Environment Variables ---
    # AAP_HOSTNAME: "https://your-aap-url.example.com"
    # AAP_USERNAME: "aap_admin_user"
    # AAP_PASSWORD: "YOUR_AAP_ADMIN_PASSWORD"

    # --- Configuration Variables ---
    aap_org_name: "Default"
    aap_app_name: "Automation Self-Service Portal"
    ocp_project_name: aap-portal
    ocp_build_config_name: plugin-registry

    # --- Artifacts ---
    aap_version: 2.6
    rhel_version: 10
    release_arch: x86_64
    aap_release_url: "ansible-automation-platform-{{ aap_version }}-for-rhel-{{ rhel_version }}-{{ release_arch }}-files"
    plugins_download_dest: "{{ playbook_dir }}/self-service-automation-portal-plugins"

  tasks:
    - name: Create Organization
      tags: aap
      ansible.platform.organization:
        name: "{{ aap_org_name }}"
        state: present

    - name: Create OAuth Application
      tags: aap
      register: r_oauth_app
      ansible.platform.application:
        name: "{{ aap_app_name }}"
        organization: "{{ aap_org_name }}"
        authorization_grant_type: authorization-code
        client_type: confidential
        redirect_uris: "https://example.com" # Placeholder URI as per documentation
        state: present

    # - name: Debug OAuth details
    #   when: r_oauth_app.changed or not r_oauth_app.client_id
    #   ansible.builtin.debug:
    #     msg: |
    #       OAuth Client ID: {{ r_oauth_app.client_id }}
    #       OAuth Client Secret: {{ r_oauth_app.client_secret }}
    #       Remember to replace the placeholder Redirect URI
    #       with the actual deployment URL after installation.

    - name: Allow OAuth2 for External Users
      tags: aap
      ansible.platform.settings:
        settings:
          ALLOW_OAUTH2_FOR_EXTERNAL_USERS: true

    - name: Create read-only token for Admin
      tags: aap
      register: r_readonly_token
      ansible.platform.token:
        description: "Self-Service Automation Portal"
        scope: read # Scope is set to 'Read' as per documentation
        state: present

    # Modified tasks from infra.aap_utilities.aap_setup_download
    - name: Login to Red Hat APIs
      tags: ['rhsm','plugins']
      register: r_rhsm_token
      ansible.builtin.uri:
        url: https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
        method: POST
        body_format: form-urlencoded
        body:
          grant_type: refresh_token
          client_id: rhsm-api
          refresh_token: "{{ rhsm_offline_token }}"

    - name: Collecting the available installers
      tags: ['rhsm','plugins']
      register: r_aap_installers
      ansible.builtin.uri:
        url: "https://api.access.redhat.com/management/v1/images/cset/{{ aap_release_url }}"
        method: GET
        return_content: true
        headers:
          Authorization: Bearer {{ r_rhsm_token.json.access_token }}

    - name: Extract download path for Self-Service Portal plugins
      tags: ['rhsm','plugins']
      ansible.builtin.set_fact:
        _aap_portal_plugins: "{{ r_aap_installers.json.body | selectattr('filename','match','self-service') | first }}"

    - name: Downloading the plugins
      tags: ['rhsm','plugins']
      ansible.builtin.get_url:
        url: "{{ _aap_portal_plugins.downloadHref }}"
        dest: "{{ playbook_dir }}/{{ _aap_portal_plugins.filename }}"
        mode: "0644"
        headers:
          Authorization: Bearer {{ r_rhsm_token.json.access_token }}

    - name: Create plugin dest
      tags: ['rhsm','plugins']
      ansible.builtin.file:
        path: "{{ plugins_download_dest }}"
        state: directory

    - name: Extract plugins
      tags: ['rhsm','plugins']
      ansible.builtin.unarchive:
        src: "{{ playbook_dir }}/{{ _aap_portal_plugins.filename }}"  
        dest: "{{ plugins_download_dest }}"
        exclude:
          - "*code*"

    - name: Create OpenShift Project
      tags: ocp
      redhat.openshift.k8s:
        state: present
        resource_definition:
          apiVersion: project.openshift.io/v1
          kind: Project
          metadata:
            name: "{{ ocp_project_name }}"

    - name: Create BuildConfig
      tags: ['ocp','plugins']
      register: r_plugin_bc
      redhat.openshift.k8s:
        state: present
        resource_definition:
          kind: BuildConfig
          apiVersion: build.openshift.io/v1
          metadata:
            name: "{{ ocp_build_config_name }}"
            namespace: "{{ ocp_project_name }}"
            labels:
              build: "{{ ocp_build_config_name }}"
          spec:
            output:
              to:
                kind: ImageStreamTag
                name: "{{ ocp_build_config_name }}:latest"
            strategy:
              type: Source
              sourceStrategy:
                from:
                  kind: ImageStreamTag
                  namespace: openshift
                  name: 'httpd:2.4-ubi8'
            source:
              type: Binary
              binary: {}

    - name: Create ImageStream
      tags: ['ocp','plugins']
      redhat.openshift.k8s:
        state: present
        resource_definition:
          kind: ImageStream
          apiVersion: image.openshift.io/v1
          metadata:
            name: "{{ ocp_build_config_name }}"
            namespace: "{{ ocp_project_name }}"
            labels:
              build: "{{ ocp_build_config_name }}"
          spec:
            lookupPolicy:
              local: false

    - name: Starts build from build config
      tags: ['ocp','plugins']
      when: r_plugin_bc is changed
      ansible.builtin.command:
        cmd: oc start-build -n {{ ocp_project_name }} {{ ocp_build_config_name }} --from-dir={{ plugins_download_dest }} --wait

    - name: Create Deployment
      tags: ['ocp','plugins']
      redhat.openshift.k8s:
        state: present
        resource_definition:
          kind: Deployment
          apiVersion: apps/v1
          metadata:
            name: "{{ ocp_build_config_name }}"
            namespace: "{{ ocp_project_name }}" 
            labels:
              app: "{{ ocp_build_config_name }}"
          spec:
            replicas: 1
            selector:
              matchLabels:
                deployment: "{{ ocp_build_config_name }}"
            template:
              metadata:
                labels:
                  deployment: "{{ ocp_build_config_name }}"
              spec:
                containers:
                  - name: "{{ ocp_build_config_name }}"
                    image: "image-registry.openshift-image-registry.svc:5000/{{ ocp_project_name }}/{{ ocp_build_config_name }}"
                    ports:
                      - containerPort: 8080
                        protocol: TCP
                      - containerPort: 8443
                        protocol: TCP

    - name: Create a Service object from an inline definition
      tags: ['ocp','plugins']
      redhat.openshift.k8s:
        state: present
        resource_definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: "{{ ocp_build_config_name }}"
            namespace: "{{ ocp_project_name }}"
            labels:
              app: "{{ ocp_build_config_name }}"
              app.kubernetes.io/component: "{{ ocp_build_config_name }}"
              app.kubernetes.io/instance: "{{ ocp_build_config_name }}"
              app.kubernetes.io/name: "{{ ocp_build_config_name }}"
          spec:
            selector:
              deployment: plugin-registry
            ports:
              - name: 8080-tcp
                protocol: TCP
                port: 8080
                targetPort: 8080
              - name: 8443-tcp
                protocol: TCP
                port: 8443
                targetPort: 8443

    - name: Create Self-Service Portal secret
      tags: ['ocp','portal','secret']
      register: r_portal_secret
      when:
        - r_oauth_app is defined
        - r_readonly_token is defined
      redhat.openshift.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: secrets-rhaap-portal
            namespace: "{{ ocp_project_name }}"
          type: Opaque
          data:
            aap-host-url: "{{ lookup('ansible.builtin.env','AAP_HOSTNAME') | b64encode }}"
            oauth-client-id: "{{ r_oauth_app.client_id | b64encode }}"
            oauth-client-secret: "{{ r_oauth_app.client_secret | b64encode }}"
            aap-token: "{{ r_readonly_token.ansible_facts.aap_token.token | b64encode }}"

    - name: Install Self-Service Portal via Helm
      tags: ['ocp','portal','helm']
      # when: r_portal_secret is success
      kubernetes.core.helm:
        name: redhat-rhaap-portal
        chart_ref: openshift-helm-charts/redhat-rhaap-portal
        release_namespace: "{{ ocp_project_name }}"
        values:
          "redhat-developer-hub":
            global:
              # convert https://api.example.com:6443 -> https://apps.example.com
              clusterRouterBase: "{{ (lookup('ansible.builtin.env', 'K8S_AUTH_HOST') | replace('api','apps'))[8:-5] }}"
          # catalog:
          #   providers:
          #     rhaap:
          #       orgs: [Default]

    - name: Wait for Deployment
      tags: ['ocp','portal']
      kubernetes.core.k8s_info:
        kind: Deployment
        name: redhat-rhaap-portal
        namespace: "{{ ocp_project_name }}"
        wait: true
        wait_timeout: 300 # 5 minutes
        wait_sleep: 10

    - name: Get Self-Service Portal Route
      tags: ['ocp','portal']
      register: r_portal_route
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Route
        name: redhat-rhaap-portal
        namespace: "{{ ocp_project_name }}"
        wait: true
        hidden_fields:
          - metadata
          - status

    - name: Update OAuth Application
      tags: ['aap','portal']
      ansible.platform.application:
        name: "{{ aap_app_name }}"
        organization: "{{ aap_org_name }}"
        redirect_uris: "https://{{ (r_portal_route.resources | first).spec.host }}/api/auth/rhaap/handler/frame"
        state: present
